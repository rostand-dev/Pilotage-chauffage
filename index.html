<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pilotage Chauffage Intelligent</title>

<!-- Ic√¥nes & PWA -->
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg1:#2563eb; --bg2:#1e3a8a; --glass:rgba(255,255,255,.12);
  --txt:#fff; --accent:#10b981; --accent-2:#059669; --stroke:rgba(255,255,255,.15);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family: Arial, sans-serif;
  margin:0; padding:0; color:var(--txt);
  background: radial-gradient(1200px 800px at 20% -10%, #3b82f6 0%, transparent 60%),
              linear-gradient(135deg, var(--bg1), var(--bg2));
  display:flex; flex-direction:column; align-items:center;
}

/* ---- Layout ---- */
header{width:100%; max-width:1200px; padding:16px 20px; text-align:center; animation:fadeDown .6s ease both}
h1{margin:0; font-size:1.7rem; letter-spacing:.2px}
main{flex:1; width:100%; max-width:900px; padding:16px}
.grid{
  display:grid; gap:16px;
  grid-template-columns: 1fr; 
}
@media(min-width:820px){ .grid{ grid-template-columns: 1fr 1fr; } }

/* ---- Cards ---- */
.card{
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:16px; padding:16px;
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.card:hover{ transform: translateY(-2px); box-shadow: 0 16px 40px rgba(0,0,0,.32); border-color:rgba(255,255,255,.25); }

/* ---- Titles ---- */
.card h2{margin:0 0 10px 0; font-size:1.15rem; letter-spacing:.2px}

/* ---- Form ---- */
label{display:block; margin-top:.65rem; font-size:.92rem; opacity:.95}
input[type="number"]{
  width:100%; margin-top:.25rem; padding:.55rem .7rem;
  border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.08);
  color:#fff; outline:none; transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
}
input::placeholder{color:#e5e7eb99}
input:focus{ border-color:#93c5fd; background:rgba(255,255,255,.14); box-shadow:0 0 0 3px rgba(147,197,253,.18) }

/* ---- Buttons ---- */
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  background:var(--accent); color:#062b21; border:0;
  padding:.65rem 1rem; border-radius:12px; font-weight:700; cursor:pointer;
  box-shadow: 0 6px 16px rgba(16,185,129,.35);
  transition: transform .15s ease, background .2s ease, box-shadow .2s ease, filter .2s ease;
}
.btn:hover{ background:var(--accent-2); box-shadow: 0 10px 24px rgba(5,150,105,.40); filter:saturate(1.05) }
.btn:active{ transform: translateY(1px) }
.btn-ghost{
  background:transparent; color:#fff; border:1px solid var(--stroke);
  box-shadow:none;
}
.btn-ghost:hover{ background:rgba(255,255,255,.08) }

/* ---- Recommendation ---- */
.reco{min-height:44px; line-height:1.35; margin-top:8px}
.badge{
  display:inline-block; padding:.25rem .6rem; border-radius:999px;
  border:1px solid var(--stroke); background:rgba(255,255,255,.10); font-size:.8rem;
}

/* ---- Canvas ---- */
canvas{background:#0b1733; border-radius:12px; border:1px solid var(--stroke)}

/* ---- Animations ---- */
@keyframes fadeUp{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
@keyframes fadeDown{ from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:translateY(0)} }
@keyframes pulseGlow{ 0%{box-shadow:0 0 0 0 rgba(16,185,129,.35)} 70%{box-shadow:0 0 0 14px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }
.appear-1{ animation:fadeUp .45s ease .05s both }
.appear-2{ animation:fadeUp .55s ease .08s both }
.appear-3{ animation:fadeUp .65s ease .12s both }

/* ---- Footer ---- */
footer{width:100%; max-width:1200px; padding:14px 20px; text-align:center; opacity:.85}
.small{font-size:.9rem; opacity:.9}

/* ---- Utility ---- */
.row{display:flex; gap:8px; flex-wrap:wrap}
.sep{height:1px; background:var(--stroke); margin:12px 0}
</style>
</head>
<body>
<header>
  <h1>üè† Pilotage Chauffage ‚Äî Assistant quotidien</h1>
</header>

<main>
  <div class="grid">
    <!-- PARAM√àTRES -->
    <section class="card appear-1">
      <h2>‚öôÔ∏è Param√®tres</h2>
      <div class="row">
        <div style="flex:1">
          <label>Latitude
            <input id="lat" type="number" step="0.0001" placeholder="ex. 50.6927">
          </label>
        </div>
        <div style="flex:1">
          <label>Longitude
            <input id="lon" type="number" step="0.0001" placeholder="ex. 3.1746">
          </label>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Seuil PAC ‚Üí Insert (¬∞C)
            <input id="seuilPac" type="number" step="0.1" placeholder="ex. 10">
          </label>
        </div>
        <div style="flex:1">
          <label>Seuil Insert ‚Üí Gaz (¬∞C)
            <input id="seuilInsert" type="number" step="0.1" placeholder="ex. 0">
          </label>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Co√ªt PAC (‚Ç¨/kWh utile)
            <input id="coutPac" type="number" step="0.001" placeholder="ex. 0.050">
          </label>
        </div>
        <div style="flex:1">
          <label>Co√ªt Insert (‚Ç¨/kWh utile)
            <input id="coutInsert" type="number" step="0.001" placeholder="ex. 0.067">
          </label>
        </div>
        <div style="flex:1">
          <label>Co√ªt Gaz (‚Ç¨/kWh utile)
            <input id="coutGaz" type="number" step="0.001" placeholder="ex. 0.120">
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveBtn" class="btn">üíæ Sauvegarder</button>
        <button id="resetBtn" class="btn btn-ghost">üóëÔ∏è R√©initialiser l‚Äôhistorique</button>
      </div>
      <div class="sep"></div>
      <div class="small">Astuce : ajuste les seuils pour d√©clencher l‚Äôinsert plus t√¥t ou retarder l‚Äôusage du gaz.</div>
    </section>

    <!-- JOUR & RECO -->
    <section class="card appear-2">
      <h2>üìÖ Recommandation du jour</h2>
      <div class="row">
        <button id="refreshBtn" class="btn" style="animation:pulseGlow 2.2s ease-out infinite">‚Üª Actualiser</button>
        <span class="badge" id="todayTag">Analyse‚Ä¶</span>
      </div>
      <div id="reco" class="reco"></div>
      <div class="small" id="eco"></div>
    </section>

    <!-- HISTO -->
    <section class="card appear-3" style="grid-column: 1 / -1">
      <h2>üìà Historique (30 derniers jours)</h2>
      <canvas id="historyChart" height="220"></canvas>
    </section>
  </div>
</main>

<footer class="small">¬© 2025 ‚Äî Optimisation √ânergie</footer>

<script>
/* ---------- Stockage ---------- */
let settings = JSON.parse(localStorage.getItem('settings') || '{}');
let historyData = JSON.parse(localStorage.getItem('history') || '[]');

/* ---------- Helpers UI ---------- */
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const n=document.createElement('div');
  n.textContent=msg;
  n.style.cssText='position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827cc;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px);z-index:9999';
  document.body.appendChild(n); setTimeout(()=>n.remove(),1600);
}
function updateTag(text, color='rgba(255,255,255,.10)'){
  const t=$('todayTag'); t.textContent=text; t.style.background=color;
}

/* ---------- Param√®tres ---------- */
function saveSettings(){
  settings = {
    lat: parseFloat($('lat').value),
    lon: parseFloat($('lon').value),
    seuilPac: parseFloat($('seuilPac').value),
    seuilInsert: parseFloat($('seuilInsert').value),
    coutPac: parseFloat($('coutPac').value),
    coutInsert: parseFloat($('coutInsert').value),
    coutGaz: parseFloat($('coutGaz').value)
  };
  localStorage.setItem('settings', JSON.stringify(settings));
  toast('Param√®tres sauvegard√©s ‚úÖ');
}
function loadSettings(){
  if(settings.lat) $('lat').value = settings.lat; else $('lat').value='';
  if(settings.lon) $('lon').value = settings.lon; else $('lon').value='';
  if(settings.seuilPac) $('seuilPac').value = settings.seuilPac; else $('seuilPac').value='';
  if(settings.seuilInsert) $('seuilInsert').value = settings.seuilInsert; else $('seuilInsert').value='';
  if(settings.coutPac) $('coutPac').value = settings.coutPac; else $('coutPac').value='';
  if(settings.coutInsert) $('coutInsert').value = settings.coutInsert; else $('coutInsert').value='';
  if(settings.coutGaz) $('coutGaz').value = settings.coutGaz; else $('coutGaz').value='';
}

/* ---------- API & Recommandation ---------- */
async function getRecommendation(){
  try{
    if(!settings.lat || !settings.lon){ toast('Renseigne latitude/longitude'); return; }
    updateTag('Mise √† jour‚Ä¶', 'rgba(59,130,246,.25)');

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${settings.lat}&longitude=${settings.lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
    const res = await fetch(url);
    const data = await res.json();
    const tmin = data.daily.temperature_2m_min[0];
    const tmax = data.daily.temperature_2m_max[0];
    const tmoy = (tmin + tmax) / 2;

    let mode = 'Gaz', badge='rgba(244,63,94,.25)';
    if(tmoy >= settings.seuilPac){ mode = 'PAC'; badge='rgba(16,185,129,.30)'; }
    else if(tmoy >= settings.seuilInsert){ mode = 'Insert'; badge='rgba(245,158,11,.30)'; }

    const cout = mode === 'PAC' ? settings.coutPac : (mode === 'Insert' ? settings.coutInsert : settings.coutGaz);
    $('reco').style.opacity = 0;
    setTimeout(()=>{
      $('reco').innerHTML = `üå° <strong>${tmoy.toFixed(1)}¬∞C</strong> ¬∑ Mode conseill√© : <strong>${mode}</strong><br>
      üí∂ Co√ªt indicatif : <strong>${(cout||0).toFixed(3)}</strong> ‚Ç¨/kWh utile`;
      $('reco').style.transition='opacity .35s ease';
      $('reco').style.opacity = 1;
    },120);
    updateTag(mode==='PAC'?'Confort doux':mode==='Insert'?'Hiver mod√©r√©':'Froid marqu√©', badge);

    // Enregistre l‚Äôhistorique (max 30 points)
    historyData.push({ date: new Date().toLocaleDateString(), mode, tmoy: Number(tmoy.toFixed(1)) });
    if(historyData.length>30) historyData.shift();
    localStorage.setItem('history', JSON.stringify(historyData));

    // √âco cumul√©es vs 100% gaz (kWh/j fictifs pour l‚Äôillustration)
    const kwhJour = 15;
    const coutGazRef = (settings.coutGaz||0)*kwhJour;
    const coutJour = (cout||0)*kwhJour;
    const ecoTot = (Number(localStorage.getItem('ecoTot')||'0') + (coutGazRef - coutJour));
    localStorage.setItem('ecoTot', ecoTot);
    $('eco').textContent = `üí∞ √âconomies cumul√©es (r√©f. tout gaz) : ${ecoTot.toFixed(2)} ‚Ç¨`;

    renderChart(true);
  }catch(e){
    console.error(e);
    updateTag('Erreur m√©t√©o', 'rgba(244,63,94,.35)');
    $('reco').textContent = 'Impossible de r√©cup√©rer la m√©t√©o. V√©rifie ta connexion et les coordonn√©es GPS.';
  }
}

/* ---------- Chart ---------- */
let chart;
function renderChart(animated=false){
  const ctx = $('historyChart').getContext('2d');
  const labels = historyData.map(e=>e.date);
  const valeurs = historyData.map(e=>e.tmoy);
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Temp√©rature moyenne (¬∞C)',
        data: valeurs,
        borderColor:'#10b981',
        backgroundColor:'rgba(16,185,129,.18)',
        pointRadius:3, pointHoverRadius:5, tension:.25, fill:true
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      animation: animated ? {duration:700, easing:'easeOutQuart'} : false,
      plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false} },
      scales:{
        x:{ grid:{display:false}, ticks:{color:'#e5e7eb'} },
        y:{ grid:{color:'rgba(255,255,255,.12)'}, ticks:{color:'#e5e7eb'} }
      }
    }
  });
}

/* ---------- Actions ---------- */
$('saveBtn').addEventListener('click', saveSettings);
$('resetBtn').addEventListener('click', ()=>{
  localStorage.removeItem('history'); historyData=[]; localStorage.setItem('ecoTot','0');
  $('eco').textContent=''; renderChart();
  toast('Historique r√©initialis√©');
});
$('refreshBtn').addEventListener('click', ()=>{ getRecommendation(); });

/* ---------- Init ---------- */
loadSettings();
renderChart();
</script>
</body>
</html>
