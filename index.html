<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ====== NAMESPACE & STORAGE ====== */
  const APP_ID = 'chauffage.v1'; // incrémente si breaking change, ex: v2
  const K = {
    settings: `${APP_ID}:settings`,
    history:  `${APP_ID}:history`,
    ecoTot:   `${APP_ID}:ecoTot`
  };

  // lecture/sauvegarde sûres
  const safeParse = (raw, fallback) => {
    try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }
  };
  const storageGet = (key, fb) => safeParse(localStorage.getItem(key), fb);
  const storageSet = (key, val) => localStorage.setItem(key, JSON.stringify(val));

  // migration depuis anciennes clés (si existantes)
  (function migrate(){
    const oldS = localStorage.getItem('settings');
    const oldH = localStorage.getItem('history');
    const oldE = localStorage.getItem('ecoTot');
    if (oldS && !localStorage.getItem(K.settings)) localStorage.setItem(K.settings, oldS);
    if (oldH && !localStorage.getItem(K.history))  localStorage.setItem(K.history,  oldH);
    if (oldE && !localStorage.getItem(K.ecoTot))   localStorage.setItem(K.ecoTot,   oldE);
  })();

  /* ====== ÉTAT ====== */
  // valeurs par défaut uniquement pour affichage; on NE sauvegarde PAS tant que l'utilisateur n'a pas cliqué
  const defaults = { lat:'', lon:'', seuilPac:'', seuilInsert:'', coutPac:'', coutInsert:'', coutGaz:'', hcStart:'00:00', hcEnd:'08:00', tKids:'20:00', tParents:'23:00' };
  let settings    = { ...defaults, ...storageGet(K.settings, {}) };   // fusion non destructive
  let historyData = storageGet(K.history,  []);
  let ecoTot      = Number(localStorage.getItem(K.ecoTot) || '0');

  /* ====== DOM HELPERS ====== */
  const $ = id => document.getElementById(id);
  const toast = (msg)=>{
    const n=document.createElement('div');
    n.textContent=msg;
    n.style.cssText='position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827cc;color:#fff;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px);z-index:9999';
    document.body.appendChild(n); setTimeout(()=>n.remove(),1600);
  };
  const updateTag = (text, color='rgba(255,255,255,.10)')=>{
    const t=$('todayTag'); if(!t) return; t.textContent=text; t.style.background=color;
  };

  /* ====== CHARGER LES CHAMPS SANS ÉCRASER LE STORAGE ====== */
  function loadSettingsToUI(){
    // on affiche ce qu'on a, sinon placeholders; on n'écrit rien dans localStorage ici
    const map = {
      lat:'lat', lon:'lon', seuilPac:'seuilPac', seuilInsert:'seuilInsert',
      coutPac:'coutPac', coutInsert:'coutInsert', coutGaz:'coutGaz',
      hcStart:'hcStart', hcEnd:'hcEnd', tKids:'tKids', tParents:'tParents'
    };
    for (const k in map){ if($(map[k]) && settings[k] !== undefined) $(map[k]).value = settings[k]; }
  }

  /* ====== SAUVEGARDE PARAMS (uniquement au clic) ====== */
  function saveSettings(){
    const getNum = (id)=> {
      const v = parseFloat($(id).value);
      return Number.isFinite(v) ? v : settings[id]; // ne pas écraser par NaN
    };
    const getStr = (id)=> $(id).value || settings[id];

    const newSettings = {
      lat: getNum('lat'), lon: getNum('lon'),
      seuilPac: getNum('seuilPac'), seuilInsert: getNum('seuilInsert'),
      coutPac: getNum('coutPac'), coutInsert: getNum('coutInsert'), coutGaz: getNum('coutGaz'),
      hcStart: getStr('hcStart') || '00:00',
      hcEnd:   getStr('hcEnd')   || '08:00',
      tKids:   getStr('tKids')   || '20:00',
      tParents:getStr('tParents')|| '23:00'
    };

    // fusion: on garde les anciennes valeurs si champ vide
    settings = Object.fromEntries(Object.keys(defaults).map(k => [k, (newSettings[k] ?? settings[k] ?? defaults[k])]));
    storageSet(K.settings, settings);
    toast('Paramètres sauvegardés ✅');
    renderOperationalTips(); // met à jour les volets
  }

  /* ====== RECOMMANDATION & HISTORIQUE ====== */
  async function getRecommendation(){
    try{
      if(!(settings.lat && settings.lon)){ toast('Renseigne latitude/longitude'); return; }
      updateTag('Mise à jour…', 'rgba(59,130,246,.25)');

      const url=`https://api.open-meteo.com/v1/forecast?latitude=${settings.lat}&longitude=${settings.lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
      const res=await fetch(url); const data=await res.json();
      const tmin=data?.daily?.temperature_2m_min?.[0]; const tmax=data?.daily?.temperature_2m_max?.[0];
      if (tmin==null || tmax==null) throw new Error('Données météo indisponibles');
      const tmoy=(tmin+tmax)/2;

      let mode='Gaz', badge='rgba(244,63,94,.25)';
      if(tmoy >= settings.seuilPac){ mode='PAC'; badge='rgba(16,185,129,.30)'; }
      else if(tmoy >= settings.seuilInsert){ mode='Insert'; badge='rgba(245,158,11,.30)'; }

      const cout = mode==='PAC'?settings.coutPac:(mode==='Insert'?settings.coutInsert:settings.coutGaz);
      $('reco') && ($('reco').innerHTML = `🌡 <b>${tmoy.toFixed(1)}°C</b> · Mode conseillé : <b>${mode}</b><br>💶 Coût indicatif : <b>${(cout||0).toFixed(3)}</b> €/kWh utile`);
      updateTag(mode==='PAC'?'Confort doux':(mode==='Insert'?'Hiver modéré':'Froid marqué'), badge);

      // Historique + éco cumulées
      historyData.push({date:new Date().toLocaleDateString(), mode, tmoy:Number(tmoy.toFixed(1))});
      if(historyData.length>30) historyData.shift();
      storageSet(K.history, historyData);

      const kwhJour=15, coutGazRef=(settings.coutGaz||0)*kwhJour, coutJour=(cout||0)*kwhJour;
      ecoTot = ecoTot + (coutGazRef - coutJour);
      localStorage.setItem(K.ecoTot, String(ecoTot));
      $('eco') && ($('eco').textContent = `💰 Économies cumulées (réf. tout gaz) : ${ecoTot.toFixed(2)} €`);

      renderChart(true); renderHistoryList(); renderOperationalTips(tmoy);
    }catch(e){
      console.error(e);
      $('reco') && ($('reco').textContent='Erreur météo — vérifie la connexion et les coordonnées GPS.');
      updateTag('Erreur', 'rgba(244,63,94,.35)');
    }
  }

  /* ====== VOLETS OPÉRATIONNELS ====== */
  const timeStrToMin = (t)=>{const [h,m]=String(t).split(':').map(n=>parseInt(n||'0',10));return h*60+m}
  const minToTimeStr = (m)=>{const h=((Math.floor(m/60)%24)+24)%24; const mm=("0"+((m%60+60)%60)).slice(-2); return ("0"+h).slice(-2)+":"+mm}
  function renderOperationalTips(tmoy=null){
    const s=settings;
    const hcStartMin=timeStrToMin(s.hcStart||'00:00');
    const hcEndMin  =timeStrToMin(s.hcEnd  ||'08:00');
    const preheatStart = Math.max(hcEndMin-120, hcStartMin);
    $('pacTips') && ($('pacTips').innerHTML = `
      <li>Entre <b>${s.hcStart||'00:00'}</b> et <b>${s.hcEnd||'08:00'}</b> : maintenir (mode auto/éco).</li>
      <li>Préchauffe <b>${minToTimeStr(preheatStart)}</b> → <b>${s.hcEnd||'08:00'}</b> pour couvrir le matin en HP.</li>
      <li>Limiter la PAC de <b>18:00</b> à <b>22:00</b> (HP) — inertie + éventuel insert.</li>
      <li>Après <b>${s.tKids||'20:00'}</b>, relance douce 30–60 min si nécessaire.</li>`
    );

    const refTmoy = (tmoy!==null)? tmoy : (historyData.slice(-1)[0]?.tmoy ?? null);
    let insertHTML='';
    if(refTmoy===null){
      insertHTML = `Allumer l’insert si T° moyenne ≤ <b>${(s.seuilPac||5)+2}°C</b> (économie vs PAC en HP).`;
    }else if(refTmoy <= (s.seuilInsert||-2)){
      insertHTML = `T° très basse → <b>17:00–18:00</b>. PAC surtout en HC, gaz en secours si besoin nuit.`;
    }else if(refTmoy <= ((s.seuilPac||5)+2)){
      insertHTML = `T° modérée (${refTmoy.toFixed(1)}°C) → <b>18:00–19:00</b> pour couvrir la soirée (HP).`;
    }else{
      insertHTML = `T° douce (${refTmoy.toFixed(1)}°C) → insert non nécessaire, PAC seule (max HC).`;
    }
    insertHTML += `<div style="margin-top:6px">⏱️ Laisser s’éteindre avant <b>${settings.tParents||'23:00'}</b>.</div>`;
    $('insertTips') && ($('insertTips').innerHTML = insertHTML);
  }

  /* ====== GRAPHIQUE & LISTE ====== */
  let chart;
  function renderChart(animated=false){
    const canvas=$('historyChart');
    if(!canvas || typeof Chart === 'undefined'){ return; }
    const ctx=canvas.getContext('2d');
    const labels=historyData.map(e=>e.date);
    const values=historyData.map(e=>e.tmoy);
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{labels,
        datasets:[{label:'Température moyenne (°C)',data:values,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.18)',tension:.25,fill:true,pointRadius:3}]},
      options:{responsive:true,maintainAspectRatio:false,
        animation:animated?{duration:700,easing:'easeOutQuart'}:false,
        plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},
        scales:{x:{grid:{display:false},ticks:{color:'#e5e7eb'}},y:{grid:{color:'rgba(255,255,255,.12)'},ticks:{color:'#e5e7eb'}}}
    });
  }
  function renderHistoryList(){
    const wrap=$('historyList'); if(!wrap) return;
    wrap.innerHTML='';
    if(!historyData.length){wrap.innerHTML='<div class="small" style="opacity:.8">Aucune donnée pour le moment.</div>'; return;}
    historyData.slice().reverse().forEach(it=>{
      const card=document.createElement('div'); card.className='history-card';
      const modeColor=it.mode==='PAC'?'rgba(16,185,129,.30)':(it.mode==='Insert'?'rgba(245,158,11,.30)':'rgba(244,63,94,.30)');
      card.innerHTML=`<div class="h-left"><div class="h-date">${it.date}</div><div class="h-mode" style="background:${modeColor}">${it.mode}</div></div>
                      <div class="h-temp">🌡 ${it.tmoy.toFixed(1)}°C</div>`;
      wrap.appendChild(card);
    });
  }

  /* ====== BIND BOUTONS ====== */
  $('saveBtn')?.setAttribute('type','button');
  $('resetBtn')?.setAttribute('type','button');
  $('refreshBtn')?.setAttribute('type','button');

  $('saveBtn')?.addEventListener('click', saveSettings);
  $('resetBtn')?.addEventListener('click', ()=>{
    localStorage.removeItem(K.history); historyData=[]; localStorage.setItem(K.ecoTot,'0'); ecoTot=0;
    $('eco') && ($('eco').textContent=''); renderChart(); renderHistoryList(); toast('Historique réinitialisé');
  });
  $('refreshBtn')?.addEventListener('click', getRecommendation);

  /* ====== INIT ====== */
  loadSettingsToUI();
  renderChart(); renderHistoryList(); renderOperationalTips();
});
</script>
